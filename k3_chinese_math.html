<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K3 ä¸­æ–‡èªå­—æ¨‚åœ’</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Zen Maru Gothic (æ—¥å¼åœ“é«”) -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #FFF8F0; /* æ—¥å¼ç±³è‰² */
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* éš±è—æ»¾å‹•æ¢ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* å‹•ç•«å®šç¾© */
        @keyframes bounce-short {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-bounce-short { animation: bounce-short 0.5s ease-in-out; }

        /* ç§»é™¤äº† pop-in å‹•ç•« */

        @keyframes float-up {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }
        
        .confetti {
            position: fixed;
            top: 100%;
            z-index: 9999;
            pointer-events: none;
            animation: float-up 3s ease-out forwards;
            font-size: 2rem;
        }

        /* è‡ªå®šç¾©æ¨£å¼é¡ */
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-press {
            transition: all 0.1s;
        }
        .btn-press:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="text-gray-800 h-screen w-full overflow-hidden relative">

    <!-- æ‡‰ç”¨ç¨‹å¼å®¹å™¨ -->
    <div id="app" class="h-full w-full max-w-5xl mx-auto flex flex-col relative">
        
        <!-- 1. ä¸»é¸å–®é é¢ - ç§»é™¤äº† animate-pop-in -->
        <div id="view-menu" class="view-section h-full flex flex-col items-center justify-center p-6 space-y-10">
            <div class="text-center space-y-4">
                <h1 class="text-5xl md:text-6xl font-bold text-gray-700 tracking-wider drop-shadow-sm">
                    <span class="text-orange-400">K3</span> ä¸­æ–‡æ¨‚åœ’
                </h1>
                <p class="text-gray-400 text-xl">å¿«æ¨‚å­¸ä¸­æ–‡ï¼Œé–‹å¿ƒç©éŠæˆ²ï¼</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-2xl">
                <button onclick="app.switchMode('learning')" class="group bg-white p-8 rounded-3xl shadow-lg border-b-8 border-green-200 hover:border-green-300 hover:-translate-y-1 transition-all flex flex-col items-center gap-4 btn-press">
                    <div class="bg-green-100 w-20 h-20 flex items-center justify-center rounded-full group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-book-open text-3xl text-green-500"></i>
                    </div>
                    <span class="text-2xl font-bold text-gray-700">å­¸ç¿’æ¨¡å¼</span>
                </button>

                <button onclick="app.switchMode('game')" class="group bg-white p-8 rounded-3xl shadow-lg border-b-8 border-blue-200 hover:border-blue-300 hover:-translate-y-1 transition-all flex flex-col items-center gap-4 btn-press">
                    <div class="bg-blue-100 w-20 h-20 flex items-center justify-center rounded-full group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-trophy text-3xl text-blue-500"></i>
                    </div>
                    <span class="text-2xl font-bold text-gray-700">éŠæˆ²æ¨¡å¼</span>
                </button>
            </div>

            <button onclick="settingsModal.open()" class="absolute top-6 right-6 bg-white p-3 rounded-full shadow-md text-gray-400 hover:text-orange-400 hover:rotate-90 transition-all">
                <i class="fa-solid fa-gear text-xl"></i>
            </button>
        </div>

        <!-- 2. å­¸ç¿’æ¨¡å¼é é¢ - ç§»é™¤äº† animate-pop-in -->
        <div id="view-learning" class="view-section hidden h-full flex flex-col p-4">
            <!-- é ‚éƒ¨å°èˆª -->
            <div class="flex items-center gap-4 mb-4">
                <button onclick="app.switchMode('menu')" class="p-3 bg-white rounded-xl shadow-sm text-gray-500 hover:bg-gray-50 btn-press shrink-0">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <div id="category-tabs" class="flex gap-3 overflow-x-auto no-scrollbar pb-2 w-full">
                    <!-- Tabs ç”± JS ç”Ÿæˆ -->
                </div>
            </div>

            <!-- å…§å®¹å€ -->
            <div class="flex-1 overflow-hidden relative rounded-3xl bg-white/50 border-2 border-white">
                <div id="learning-grid" class="h-full overflow-y-auto p-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 content-start">
                    <!-- å­—å¡ ç”± JS ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- 3. éŠæˆ²æ¨¡å¼é é¢ - ç§»é™¤äº† animate-pop-in -->
        <div id="view-game" class="view-section hidden h-full flex flex-col p-4 relative">
            <!-- é ‚éƒ¨æ¬„ -->
            <div class="flex justify-between items-center mb-6">
                <button onclick="app.switchMode('menu')" class="p-3 bg-white rounded-full shadow-sm text-gray-500 btn-press">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <div class="flex items-center gap-2 bg-yellow-100 px-6 py-2 rounded-full text-yellow-700 font-bold shadow-inner border-2 border-yellow-200">
                    <i class="fa-solid fa-star text-yellow-400"></i>
                    <span id="score-display" class="text-xl">åˆ†æ•¸: 0</span>
                </div>
            </div>

            <!-- é¡Œç›®å€ -->
            <div class="flex-1 flex flex-col items-center justify-center mb-6 relative z-10">
                <div class="bg-white w-full max-w-md rounded-3xl p-8 shadow-xl border-b-8 border-blue-100 flex flex-col items-center text-center relative overflow-hidden transition-all duration-300" id="question-card">
                    <div class="absolute top-0 left-0 w-full h-4 bg-blue-200"></div>
                    
                    <h2 class="text-gray-400 mb-6 font-bold text-lg">è«‹æ‰¾å‡ºé€™å€‹å­—</h2>
                    
                    <!-- æç¤ºå€ï¼šåœ–ç‰‡æˆ–è²éŸ³æŒ‰éˆ• -->
                    <div id="question-hint-area" class="mb-6 h-32 flex items-center justify-center w-full">
                        <!-- JS å¡«å…… -->
                    </div>

                    <p class="text-gray-400 text-sm">( é»æ“Šå–‡å­å¯ä»¥å†è½ä¸€æ¬¡ )</p>
                </div>
            </div>

            <!-- é¸é …å€ -->
            <div id="options-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4 max-w-4xl mx-auto w-full z-10 pb-4">
                <!-- é¸é … ç”± JS ç”Ÿæˆ -->
            </div>
        </div>

        <!-- å½ˆçª—ï¼šç”Ÿå­—è©³ç´° (å­¸ç¿’æ¨¡å¼) -->
        <div id="modal-word" class="fixed inset-0 bg-black/40 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
            <!-- ç§»é™¤äº† animate-pop-in -->
            <div class="bg-white rounded-3xl p-6 w-full max-w-md shadow-2xl border-4 border-yellow-100 relative">
                <button onclick="learningMode.closeModal()" class="absolute top-4 right-4 text-gray-300 hover:text-gray-500 w-8 h-8 flex items-center justify-center rounded-full bg-gray-50">
                    <i class="fa-solid fa-xmark"></i>
                </button>
                
                <div id="modal-word-content" class="flex flex-col items-center text-center pt-4">
                    <div id="modal-emoji" class="text-8xl mb-4 animate-bounce-short hidden"></div>
                    <h2 id="modal-text" class="text-6xl font-bold text-gray-800 mb-8 tracking-widest text-shadow-sm"></h2>
                    
                    <div class="bg-orange-50 rounded-xl p-5 w-full mb-8 relative border-2 border-orange-100">
                        <div class="absolute -top-3 left-4 bg-orange-200 text-orange-700 text-xs px-3 py-1 rounded-full font-bold shadow-sm">
                            ä¾‹å¥
                        </div>
                        <p id="modal-sentence" class="text-xl text-gray-700 leading-relaxed font-medium mt-2"></p>
                    </div>

                    <div class="flex gap-4 w-full">
                        <button onclick="learningMode.playWord()" class="flex-1 bg-blue-100 text-blue-600 py-4 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-blue-200 transition-colors btn-press shadow-sm border-b-4 border-blue-200">
                            <i class="fa-solid fa-volume-high"></i> è®€å­—
                        </button>
                        <button onclick="learningMode.playSentence()" class="flex-1 bg-green-100 text-green-600 py-4 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-green-200 transition-colors btn-press shadow-sm border-b-4 border-green-200">
                            <i class="fa-solid fa-volume-low"></i> è®€å¥
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å½ˆçª—ï¼šè¨­å®š -->
        <div id="modal-settings" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
             <!-- ç§»é™¤äº† animate-pop-in -->
            <div class="bg-white rounded-3xl p-6 w-full max-w-md shadow-xl border-4 border-orange-200">
                <h2 class="text-2xl font-bold text-gray-700 mb-6 flex items-center gap-2">
                    <i class="fa-solid fa-gear text-orange-400"></i> è¨­å®š
                </h2>
                
                <div class="space-y-6">
                    <!-- å­—é«”å¤§å° -->
                    <div>
                        <label class="block text-gray-600 font-bold mb-2">æ–‡å­—å¤§å°</label>
                        <div class="flex gap-2">
                            <button onclick="settingsModal.setSize('normal')" class="btn-size flex-1 py-3 rounded-xl border-2 transition-all font-bold text-lg" data-size="normal">æ¨™æº–</button>
                            <button onclick="settingsModal.setSize('large')" class="btn-size flex-1 py-3 rounded-xl border-2 transition-all font-bold text-xl" data-size="large">å¤§</button>
                            <button onclick="settingsModal.setSize('xl')" class="btn-size flex-1 py-3 rounded-xl border-2 transition-all font-bold text-2xl" data-size="xl">ç‰¹å¤§</button>
                        </div>
                    </div>

                    <!-- é¡¯ç¤ºåœ–ç‰‡ -->
                    <div class="flex items-center justify-between bg-orange-50 p-4 rounded-xl border-2 border-orange-100">
                        <label class="text-gray-700 font-bold flex items-center gap-2">
                            <i class="fa-solid fa-image text-orange-400"></i> é¡¯ç¤ºåœ–ç‰‡ (Emoji)
                        </label>
                        <button onclick="settingsModal.toggleImages()" id="btn-toggle-img" class="w-14 h-8 rounded-full p-1 transition-colors bg-gray-300">
                            <div id="toggle-circle" class="bg-white w-6 h-6 rounded-full shadow-md transform transition-transform translate-x-0"></div>
                        </button>
                    </div>
                </div>

                <button onclick="settingsModal.close()" class="mt-8 w-full bg-orange-400 text-white font-bold py-3 rounded-2xl hover:bg-orange-500 transition-colors shadow-lg btn-press border-b-4 border-orange-600">
                    å®Œæˆ
                </button>
            </div>
        </div>
        
        <!-- æ…¶ç¥ç‰¹æ•ˆå±¤ -->
        <div id="celebration-overlay" class="fixed inset-0 pointer-events-none z-40 hidden flex items-center justify-center">
             <!-- ç§»é™¤äº† animate-pop-in -->
            <div class="bg-white/90 backdrop-blur-md p-8 rounded-3xl shadow-2xl border-8 border-green-300 transform scale-100 flex flex-col items-center">
                <div class="text-8xl mb-2 animate-bounce-short">ğŸ‰</div>
                <div class="text-4xl font-bold text-green-600 text-center drop-shadow-sm">å¥½å»ï¼ç­”å•±äº†ï¼</div>
            </div>
        </div>

    </div>

    <!-- é‚è¼¯è…³æœ¬ -->
    <script>
        // --- 1. è³‡æ–™åº« ---
        const VOCAB_DATA = {
            "æ¨‚": [
                { word: "å¿«æ¨‚", emoji: "ğŸ˜Š", sentence: "æˆ‘ä»Šå¤©éå¾—å¾ˆå¿«æ¨‚ã€‚" },
                { word: "æ¨‚è¶£", emoji: "ğŸ¤¹", sentence: "å­¸ç¿’å……æ»¿äº†æ¨‚è¶£ã€‚" },
                { word: "æ¨‚æ›²", emoji: "ğŸµ", sentence: "é€™é¦–æ¨‚æ›²å¾ˆå¥½è½ã€‚" },
                { word: "æ¨‚åœ’", emoji: "ğŸ¡", sentence: "æˆ‘å€‘å»å…’ç«¥æ¨‚åœ’ç©ã€‚" },
                { word: "æ¨‚è­œ", emoji: "ğŸ¼", sentence: "å§å§æ­£åœ¨çœ‹æ¨‚è­œç·´ç´ã€‚" }
            ],
            "ç‰¹": [
                { word: "ç‰¹åˆ¥", emoji: "âœ¨", sentence: "é€™ä»½ç¦®ç‰©å¾ˆç‰¹åˆ¥ã€‚" },
                { word: "ç‰¹å¾µ", emoji: "ğŸ˜", sentence: "é•·é¼»å­æ˜¯å¤§è±¡çš„ç‰¹å¾µã€‚" },
                { word: "ç‰¹è‰²", emoji: "ğŸŒŸ", sentence: "é€™æ˜¯é¦™æ¸¯çš„ç‰¹è‰²å°é£Ÿã€‚" },
                { word: "ç‰¹ç”¢", emoji: "ğŸ", sentence: "é€™æ˜¯å¾æ—¥æœ¬å¸¶å›ä¾†çš„ç‰¹ç”¢ã€‚" },
                { word: "ç‰¹é»", emoji: "ğŸ“", sentence: "é€™å€‹ç©å…·çš„ç‰¹é»æ˜¯æœƒç™¼å…‰ã€‚" }
            ],
            "è¡Œ": [
                { word: "æ—…è¡Œ", emoji: "âœˆï¸", sentence: "æš‘å‡æˆ‘å€‘å»æ—¥æœ¬æ—…è¡Œã€‚" },
                { word: "è¡Œå‹•", emoji: "ğŸƒ", sentence: "æˆ‘å€‘è¦é¦¬ä¸Šè¡Œå‹•ï¼" },
                { word: "è¡Œç¨‹", emoji: "ğŸ—“ï¸", sentence: "ä»Šå¤©çš„è¡Œç¨‹å¾ˆç·Šæ¹Šã€‚" },
                { word: "è¡Œæ", emoji: "ğŸ§³", sentence: "çˆ¸çˆ¸å¹«å¿™æ¬é‹å¤§è¡Œæã€‚" },
                { word: "è¡Œæ¥­", emoji: "ğŸ‘¨â€âš•ï¸", sentence: "é†«ç”Ÿæ˜¯ä¸€å€‹å—å°Šæ•¬çš„è¡Œæ¥­ã€‚" }
            ],
            "æ¸…": [
                { word: "æ¸…æ¥š", emoji: "ğŸ‘“", sentence: "é»‘æ¿ä¸Šçš„å­—çœ‹å¾—å¾ˆæ¸…æ¥šã€‚" },
                { word: "æ¸…æ™¨", emoji: "ğŸŒ…", sentence: "æ¸…æ™¨çš„ç©ºæ°£å¾ˆæ¸…æ–°ã€‚" },
                { word: "æ¸…ç†", emoji: "ğŸ§¹", sentence: "æˆ‘å€‘è¦æ¸…ç†å¥½è‡ªå·±çš„æˆ¿é–“ã€‚" },
                { word: "æ¸…ç™½", emoji: "â˜ï¸", sentence: "ä»–æ˜¯æ¸…ç™½çš„ï¼Œæ²’æœ‰èªªè¬Šã€‚" },
                { word: "æ¸…æ·¡", emoji: "ğŸ¥—", sentence: "çˆºçˆºå–œæ­¡åƒæ¸…æ·¡çš„é£Ÿç‰©ã€‚" }
            ],
            "è«‹": [
                { word: "è«‹æ•™", emoji: "ğŸ™‹", sentence: "æˆ‘æœ‰å•é¡Œè¦è«‹æ•™è€å¸«ã€‚" },
                { word: "è«‹å‡", emoji: "ğŸ“", sentence: "å°æ˜ç”Ÿç—…äº†ï¼Œè¦å‘å­¸æ ¡è«‹å‡ã€‚" },
                { word: "è«‹å•", emoji: "â“", sentence: "è«‹å•åœ–æ›¸é¤¨åœ¨å“ªè£¡ï¼Ÿ" },
                { word: "è«‹æ±‚", emoji: "ğŸ™", sentence: "æˆ‘è«‹æ±‚åª½åª½è®“æˆ‘çœ‹é›»è¦–ã€‚" },
                { word: "è«‹å®¢", emoji: "ğŸ½ï¸", sentence: "ä»Šå¤©çˆ¸çˆ¸è«‹å®¢åƒå¤§é¤ã€‚" }
            ],
            "èŒ¶": [
                { word: "èŒ¶è‘‰", emoji: "ğŸƒ", sentence: "é€™äº›èŒ¶è‘‰å¾ˆé¦™ã€‚" },
                { word: "èŒ¶æœƒ", emoji: "ğŸµ", sentence: "åª½åª½åƒåŠ äº†ä¸€å€‹ä¸‹åˆèŒ¶æœƒã€‚" },
                { word: "èŒ¶å…·", emoji: "ğŸ«–", sentence: "é€™å¥—èŒ¶å…·å¾ˆç²¾ç·»ã€‚" },
                { word: "èŒ¶æ¯", emoji: "ğŸ¥ƒ", sentence: "è«‹å°å¿ƒæ‹¿è‘—èŒ¶æ¯ã€‚" },
                { word: "èŒ¶åœ’", emoji: "ğŸŒ³", sentence: "èŒ¶åœ’è£¡ç¨®æ»¿äº†ç¶ èŒ¶æ¨¹ã€‚" }
            ],
            "é›£": [
                { word: "é›£é¡Œ", emoji: "ğŸ§©", sentence: "é€™é“æ•¸å­¸é¡Œæ˜¯å€‹é›£é¡Œã€‚" },
                { word: "é›£å¾—", emoji: "ğŸ’", sentence: "é€™æ˜¯å€‹é›£å¾—çš„æ©Ÿæœƒã€‚" },
                { word: "é›£åº¦", emoji: "ğŸ“‰", sentence: "é€™å€‹éŠæˆ²å¾ˆæœ‰é›£åº¦ã€‚" },
                { word: "é›£é", emoji: "ğŸ˜¢", sentence: "å°ç‹—ç”Ÿç—…äº†ï¼Œæˆ‘å¾ˆé›£éã€‚" },
                { word: "é›£é—œ", emoji: "ğŸš§", sentence: "æˆ‘å€‘è¦ä¸€èµ·åº¦éé›£é—œã€‚" }
            ],
            "å–„": [
                { word: "å–„è‰¯", emoji: "ğŸ˜‡", sentence: "ç™½é›ªå…¬ä¸»å¾ˆå–„è‰¯ã€‚" },
                { word: "å–„äº‹", emoji: "ğŸ¤", sentence: "æˆ‘å€‘è¦å¤šåšå–„äº‹å¹«åŠ©åˆ¥äººã€‚" },
                { word: "å–„å ±", emoji: "â¤ï¸", sentence: "å¥½äººæœƒæœ‰å–„å ±ã€‚" },
                { word: "å–„å¿˜", emoji: "ğŸ¤”", sentence: "çˆºçˆºå¹´ç´€å¤§äº†ï¼Œæ¯”è¼ƒå–„å¿˜ã€‚" },
                { word: "å–„è®Š", emoji: "ğŸ¦", sentence: "å…­æœˆçš„å¤©æ°£å¾ˆå–„è®Šï¼Œæ™‚æ™´æ™‚é›¨ã€‚" }
            ]
        };

        const ALL_WORDS = Object.values(VOCAB_DATA).flat();

        // --- 2. å…¨å±€ç‹€æ…‹èˆ‡å·¥å…· ---
        const state = {
            mode: 'menu', // menu, learning, game
            settings: {
                fontSize: 'normal', // normal, large, xl
                showImages: false
            },
            learning: {
                category: Object.keys(VOCAB_DATA)[0],
                currentWord: null
            },
            game: {
                score: 0,
                currentQuestion: null,
                options: [],
                isProcessing: false
            }
        };

        const utils = {
            // ç™¼éŸ³åŠŸèƒ½
            speak: (text) => {
                if (!window.speechSynthesis) return;
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-HK';
                utterance.rate = 0.85; // ç¨å¾®æ…¢ä¸€é»
                
                // å˜—è©¦ç²å–å»£æ±è©±è²éŸ³
                const voices = window.speechSynthesis.getVoices();
                const cantoneseVoice = voices.find(v => v.lang.includes('HK') || v.lang.includes('yue'));
                if (cantoneseVoice) utterance.voice = cantoneseVoice;

                window.speechSynthesis.speak(utterance);
            },
            
            // éš¨æ©Ÿæ‰“äº‚é™£åˆ—
            shuffle: (array) => {
                const newArr = [...array];
                for (let i = newArr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
                }
                return newArr;
            },

            // ç”¢ç”Ÿæ…¶ç¥å½©å¸¶ (Emoji Confetti)
            createConfetti: () => {
                const emojis = ['ğŸ‰', 'â­', 'ğŸŒ¸', 'âœ¨', 'ğŸˆ', 'ğŸ¬'];
                const count = 30;
                
                for(let i=0; i<count; i++) {
                    const el = document.createElement('div');
                    el.classList.add('confetti');
                    el.innerText = emojis[Math.floor(Math.random() * emojis.length)];
                    el.style.left = Math.random() * 100 + 'vw';
                    el.style.animationDuration = (Math.random() * 2 + 1.5) + 's';
                    el.style.fontSize = (Math.random() * 1.5 + 1) + 'rem';
                    document.body.appendChild(el);
                    
                    // å‹•ç•«çµæŸå¾Œç§»é™¤
                    setTimeout(() => el.remove(), 3500);
                }
            }
        };

        // --- 3. æ¨¡çµ„é‚è¼¯ ---

        // APP ä¸»æ§
        const app = {
            init: () => {
                // é è¼‰èªéŸ³åˆ—è¡¨
                if (window.speechSynthesis) {
                    window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
                }
                settingsModal.updateUI();
            },

            switchMode: (newMode) => {
                // éš±è—æ‰€æœ‰è¦–åœ–
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                
                // æ›´æ–°ç‹€æ…‹
                state.mode = newMode;

                // åˆå§‹åŒ–ä¸¦é¡¯ç¤ºæ–°è¦–åœ–
                if (newMode === 'menu') {
                    document.getElementById('view-menu').classList.remove('hidden');
                } else if (newMode === 'learning') {
                    document.getElementById('view-learning').classList.remove('hidden');
                    learningMode.renderTabs();
                    learningMode.renderGrid();
                } else if (newMode === 'game') {
                    document.getElementById('view-game').classList.remove('hidden');
                    gameMode.start();
                }
            }
        };

        // å­¸ç¿’æ¨¡å¼é‚è¼¯
        const learningMode = {
            renderTabs: () => {
                const container = document.getElementById('category-tabs');
                container.innerHTML = Object.keys(VOCAB_DATA).map(cat => `
                    <button onclick="learningMode.setCategory('${cat}')" 
                        class="shrink-0 px-6 py-3 rounded-xl font-bold text-xl shadow-sm transition-all border-b-4
                        ${state.learning.category === cat 
                            ? 'bg-orange-400 text-white border-orange-600 transform scale-105' 
                            : 'bg-white text-gray-400 border-gray-200 hover:bg-orange-50'}">
                        ${cat}
                    </button>
                `).join('');
            },

            setCategory: (cat) => {
                state.learning.category = cat;
                learningMode.renderTabs();
                learningMode.renderGrid();
            },

            renderGrid: () => {
                const container = document.getElementById('learning-grid');
                const words = VOCAB_DATA[state.learning.category];
                
                // æ¨£å¼
                const sizeClass = state.settings.fontSize === 'normal' ? 'text-2xl' : state.settings.fontSize === 'large' ? 'text-3xl' : 'text-4xl';
                const emojiSize = state.settings.fontSize === 'normal' ? 'text-4xl' : state.settings.fontSize === 'large' ? 'text-5xl' : 'text-6xl';

                container.innerHTML = words.map((item, idx) => `
                    <button onclick="learningMode.openModal(${idx})" 
                        class="bg-white rounded-2xl p-4 shadow-md border-b-4 border-orange-100 hover:border-orange-300 hover:-translate-y-1 transition-all flex flex-col items-center justify-center gap-2 aspect-square btn-press">
                        ${state.settings.showImages ? `<span class="${emojiSize} animate-bounce-short">${item.emoji}</span>` : ''}
                        <span class="${sizeClass} font-bold text-gray-700 tracking-widest">${item.word}</span>
                    </button>
                `).join('');
            },

            openModal: (idx) => {
                const wordData = VOCAB_DATA[state.learning.category][idx];
                state.learning.currentWord = wordData;

                // å¡«å……å…§å®¹
                const emojiEl = document.getElementById('modal-emoji');
                emojiEl.innerText = wordData.emoji;
                emojiEl.className = `text-8xl mb-4 animate-bounce-short ${state.settings.showImages ? 'block' : 'hidden'}`;

                document.getElementById('modal-text').innerText = wordData.word;
                document.getElementById('modal-sentence').innerText = wordData.sentence;

                // é¡¯ç¤ºå½ˆçª—
                document.getElementById('modal-word').classList.remove('hidden');

                // è‡ªå‹•è®€å­—
                utils.speak(wordData.word);
                setTimeout(() => utils.speak(wordData.sentence), 1200);
            },

            closeModal: () => {
                document.getElementById('modal-word').classList.add('hidden');
                window.speechSynthesis.cancel();
            },

            playWord: () => {
                if(state.learning.currentWord) utils.speak(state.learning.currentWord.word);
            },

            playSentence: () => {
                if(state.learning.currentWord) utils.speak(state.learning.currentWord.sentence);
            }
        };

        // éŠæˆ²æ¨¡å¼é‚è¼¯
        const gameMode = {
            start: () => {
                state.game.score = 0;
                gameMode.updateScoreUI();
                gameMode.nextQuestion();
            },

            nextQuestion: () => {
                state.game.isProcessing = false;
                
                // éš¨æ©Ÿé¸å­—
                const randomWord = ALL_WORDS[Math.floor(Math.random() * ALL_WORDS.length)];
                // éš¨æ©Ÿé¸éŒ¯èª¤é¸é …
                const distractors = utils.shuffle(ALL_WORDS.filter(w => w.word !== randomWord.word)).slice(0, 5);
                const options = utils.shuffle([randomWord, ...distractors]);

                state.game.currentQuestion = randomWord;
                state.game.options = options;

                gameMode.renderUI();
                
                // å»¶é²è®€é¡Œ
                setTimeout(() => {
                    utils.speak(`è«‹æ‰¾å‡º... ${randomWord.word}`);
                }, 500);
            },

            renderUI: () => {
                const q = state.game.currentQuestion;
                
                // æ¸²æŸ“æç¤ºå€ (åœ–ç‰‡æˆ–è²éŸ³åœ–æ¨™)
                const hintArea = document.getElementById('question-hint-area');
                if (state.settings.showImages) {
                    hintArea.innerHTML = `<div class="text-8xl animate-bounce-short">${q.emoji}</div>`;
                } else {
                    hintArea.innerHTML = `
                        <button onclick="utils.speak('${q.word}')" class="bg-blue-100 w-24 h-24 rounded-full text-blue-500 hover:bg-blue-200 transition-colors flex items-center justify-center animate-pulse">
                            <i class="fa-solid fa-volume-high text-4xl"></i>
                        </button>
                    `;
                }

                // æ¸²æŸ“é¸é …
                const optContainer = document.getElementById('options-grid');
                const textSize = state.settings.fontSize === 'normal' ? 'text-xl' : state.settings.fontSize === 'large' ? 'text-2xl' : 'text-3xl';
                
                optContainer.innerHTML = state.game.options.map(opt => `
                    <button onclick="gameMode.checkAnswer('${opt.word}')" 
                        class="${textSize} font-bold p-6 rounded-2xl shadow-md transition-all border-b-4 bg-white border-gray-100 text-gray-700 hover:bg-orange-50 hover:border-orange-200 btn-press active:scale-95">
                        ${opt.word}
                    </button>
                `).join('');
            },

            checkAnswer: (selectedWord) => {
                if (state.game.isProcessing) return;

                if (selectedWord === state.game.currentQuestion.word) {
                    // ç­”å°äº†
                    state.game.isProcessing = true;
                    state.game.score += 1;
                    gameMode.updateScoreUI();
                    
                    // ç‰¹æ•ˆ
                    utils.speak("å¥½å»ï¼ç­”å•±äº†ï¼");
                    gameMode.showCelebration();

                } else {
                    // ç­”éŒ¯äº†
                    utils.speak("å“å‘€ï¼Œå†è©¦ä¸€æ¬¡å§ï¼");
                    // å¯ä»¥åŠ å…¥æ–æ™ƒå‹•ç•«
                    const card = document.getElementById('question-card');
                    card.classList.add('animate-bounce');
                    setTimeout(() => card.classList.remove('animate-bounce'), 500);
                }
            },

            showCelebration: () => {
                // 1. é¡¯ç¤ºè¦†è“‹å±¤
                const overlay = document.getElementById('celebration-overlay');
                overlay.classList.remove('hidden');
                
                // 2. ç™¼å°„å½©å¸¶
                utils.createConfetti();

                // 3. å»¶é²å¾Œé€²å…¥ä¸‹ä¸€é¡Œ
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    gameMode.nextQuestion();
                }, 2500);
            },

            updateScoreUI: () => {
                document.getElementById('score-display').innerText = `åˆ†æ•¸: ${state.game.score}`;
            }
        };

        // è¨­å®šæ¨¡çµ„
        const settingsModal = {
            open: () => {
                document.getElementById('modal-settings').classList.remove('hidden');
                settingsModal.updateUI();
            },
            
            close: () => {
                document.getElementById('modal-settings').classList.add('hidden');
                // å¦‚æœæ­£åœ¨å­¸ç¿’æ¨¡å¼ï¼Œåˆ·æ–°ä¸€ä¸‹ç¶²æ ¼ä»¥æ‡‰ç”¨æ–°è¨­å®š
                if (state.mode === 'learning') learningMode.renderGrid();
                if (state.mode === 'game') gameMode.renderUI();
            },

            setSize: (size) => {
                state.settings.fontSize = size;
                settingsModal.updateUI();
            },

            toggleImages: () => {
                state.settings.showImages = !state.settings.showImages;
                settingsModal.updateUI();
            },

            updateUI: () => {
                // æ›´æ–°å­—é«”æŒ‰éˆ•ç‹€æ…‹
                document.querySelectorAll('.btn-size').forEach(btn => {
                    if (btn.dataset.size === state.settings.fontSize) {
                        btn.className = 'btn-size flex-1 py-3 rounded-xl border-2 transition-all font-bold bg-orange-100 border-orange-400 text-orange-600';
                    } else {
                        btn.className = 'btn-size flex-1 py-3 rounded-xl border-2 transition-all font-bold bg-gray-50 border-gray-200 text-gray-500';
                    }
                });

                // æ›´æ–°åœ–ç‰‡é–‹é—œç‹€æ…‹
                const toggleBtn = document.getElementById('btn-toggle-img');
                const circle = document.getElementById('toggle-circle');
                if (state.settings.showImages) {
                    toggleBtn.className = 'w-14 h-8 rounded-full p-1 transition-colors bg-green-400';
                    circle.className = 'bg-white w-6 h-6 rounded-full shadow-md transform transition-transform translate-x-6';
                } else {
                    toggleBtn.className = 'w-14 h-8 rounded-full p-1 transition-colors bg-gray-300';
                    circle.className = 'bg-white w-6 h-6 rounded-full shadow-md transform transition-transform translate-x-0';
                }
            }
        };

        // å•Ÿå‹•
        app.init();

    </script>
</body>
</html>