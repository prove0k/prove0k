<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>K1 Âø´Ê®ÇË≠òÂ≠óÂ∞èÊ®ÇÂúí</title>
    <!-- ÂºïÂÖ•ÂúìÊΩ§ÂèØÊÑõÁöÑÂ≠óÈ´î -->
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #FFFDF5; /* Á±≥ÁôΩËâ≤ËÉåÊôØ */
            --primary-color: #FFB7B2; /* ÊüîÂíåÁ≤âÁ¥Ö */
            --secondary-color: #B5EAD7; /* ËñÑËç∑Á∂† */
            --accent-color: #C7CEEA; /* Ê∑°Á¥´Ëóç */
            --text-color: #555555; /* Ê∑±ÁÅ∞Ôºå‰∏çÂà∫Áúº */
            --card-bg: #FFFFFF;
            --shadow: 4px 4px 0px rgba(0,0,0,0.08);
            --radius: 20px;
            
            /* Dynamic Settings Variables */
            --word-size: 1.5rem;
            --img-size: 3rem;
            --img-display: block; /* block or none */
        }

        * {
            box-sizing: border-box;
            user-select: none; /* Èò≤Ê≠¢Â∞èÊúãÂèãÈÅ∏‰∏≠ÊñáÂ≠ó */
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Zen Maru Gothic', 'Varela Round', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* Header Navigation */
        header {
            background: var(--card-bg);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--primary-color);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        h1 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .mode-switch {
            display: flex;
            gap: 10px;
        }

        .btn {
            background: white;
            border: 2px solid var(--accent-color);
            border-radius: 50px;
            padding: 8px 16px;
            font-size: 1rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-color);
            font-weight: bold;
            box-shadow: 2px 2px 0px var(--accent-color);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn.active {
            background: var(--accent-color);
            color: white;
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        .btn:active {
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        .settings-btn {
            border-color: #ddd;
            box-shadow: 2px 2px 0px #ddd;
            color: #888;
        }

        /* Main Container */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 80px;
        }

        /* Theme Selector */
        .theme-scroll {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding: 10px 5px;
            margin-bottom: 20px;
            scrollbar-width: none; /* Hide scrollbar */
        }
        .theme-scroll::-webkit-scrollbar { display: none; }

        .theme-btn {
            background: var(--secondary-color);
            border: none;
            padding: 12px 20px;
            border-radius: var(--radius);
            white-space: nowrap;
            font-size: 1rem;
            font-weight: bold;
            color: #4a7c68;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: transform 0.2s;
        }

        .theme-btn.active {
            background: var(--primary-color);
            color: white;
            transform: scale(1.05);
        }

        /* Content Areas */
        .section-title {
            font-size: 1.4rem;
            margin: 20px 0 15px 0;
            padding-left: 15px;
            border-left: 5px solid var(--primary-color);
            color: var(--text-color);
        }

        /* Word Cards Grid */
        .word-group {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            border: 2px solid #f0f0f0;
        }

        .group-header {
            font-size: 1.6rem; /* ÊîæÂ§ßÂ≠óÈ´î */
            font-weight: bold; /* Âä†Á≤óÂ≠óÈ´î */
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .group-header span {
            background: #FFF0F0;
            padding: 5px 15px;
            border-radius: 20px;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 15px;
        }

        .word-card {
            background: #FAFAFA;
            border: 2px solid var(--secondary-color);
            border-radius: 15px;
            min-height: 140px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            gap: 5px;
        }

        .word-card:hover {
            transform: scale(1.05) rotate(-2deg);
            background: white;
            box-shadow: 0 5px 15px rgba(181, 234, 215, 0.4);
        }

        .word-card:active {
            transform: scale(0.95);
        }

        .word-img {
            font-size: var(--img-size);
            display: var(--img-display);
            line-height: 1;
            margin-bottom: 5px;
            transition: font-size 0.2s;
        }

        .word-text {
            font-size: var(--word-size);
            font-weight: 700;
            color: #444;
            text-align: center;
            line-height: 1.2;
            transition: font-size 0.2s;
        }

        /* Sentence Strips */
        .sentence-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .sentence-strip {
            background: white;
            padding: 15px 20px;
            border-radius: 50px;
            border: 2px solid var(--accent-color);
            font-size: var(--word-size);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: var(--shadow);
            transition: transform 0.2s;
        }

        .sentence-strip:active {
            transform: scale(0.98);
        }

        .speaker-icon {
            font-size: 1.2rem;
            opacity: 0.6;
        }

        /* Game Mode Styles */
        #game-area {
            display: none;
            text-align: center;
            padding-top: 20px;
        }

        .game-header {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            display: inline-block;
        }

        .game-controls {
            margin-bottom: 30px;
        }

        .play-sound-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 0 #e5a49f;
            transition: transform 0.1s;
            animation: pulse 2s infinite;
        }

        .play-sound-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .game-options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 columns for mobile friendly */
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        @media (min-width: 600px) {
            .game-options-grid {
                grid-template-columns: repeat(3, 1fr); /* 3 columns for desktop */
            }
        }

        .game-card {
            background: white;
            border: 3px solid var(--accent-color);
            border-radius: 20px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 120px;
        }

        .game-card:active {
            transform: scale(0.95);
        }

        .game-card.correct {
            background-color: #C8E6C9; /* Green */
            border-color: #4CAF50;
            transform: scale(1.05);
        }

        .game-card.wrong {
            background-color: #FFCDD2; /* Red */
            border-color: #F44336;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-10px); }
            100% { transform: translateX(0); }
        }

        /* Settings Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
        }

        .settings-modal {
            background: white;
            width: 90%;
            max-width: 400px;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 4px solid var(--primary-color);
        }

        .settings-header {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .setting-item {
            margin-bottom: 20px;
        }

        .setting-label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #666;
        }

        .range-slider {
            width: 100%;
            height: 10px;
            background: #eee;
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: var(--secondary-color);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f5f5f5;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
        }

        .toggle-checkbox {
            width: 20px;
            height: 20px;
        }

        .close-btn {
            background: #eee;
            border: none;
            padding: 5px 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* Feedback Overlay */
        .feedback-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .feedback-emoji {
            font-size: 8rem;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.5s ease-out;
            text-shadow: 0 0 30px white;
        }

        .feedback-emoji.show {
            opacity: 1;
            transform: scale(1.2);
        }

        /* Footer / Settings */
        .footer-note {
            text-align: center;
            margin-top: 40px;
            font-size: 0.8rem;
            color: #999;
        }

        /* Animations */
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .animate-pop {
            animation: pop 0.3s ease-in-out;
        }

    </style>
</head>
<body>

<header>
    <div class="header-left">
        <h1>üê∞ <span style="font-size: 0.9em;">Ë≠òÂ≠óÂ∞èÊ®ÇÂúí</span></h1>
    </div>
    
    <div style="display: flex; gap: 10px; align-items: center;">
        <div class="mode-switch">
            <button class="btn active" onclick="switchMode('learn')" id="btn-learn">üìñ Â≠∏Áøí</button>
            <button class="btn" onclick="switchMode('game')" id="btn-game">üéÆ ÈÅäÊà≤</button>
        </div>
        <button class="btn settings-btn" onclick="toggleSettings()">‚öôÔ∏è Ë®≠ÂÆö</button>
    </div>
</header>

<div class="container">
    
    <!-- Theme Navigation -->
    <div class="theme-scroll" id="theme-nav">
        <!-- Generated by JS -->
    </div>

    <!-- Learning Mode View -->
    <div id="learn-area">
        <div id="content-display">
            <!-- Dynamic Content -->
        </div>
    </div>

    <!-- Game Mode View -->
    <div id="game-area">
        <div class="game-header">üëÇ ËÅΩ‰∏ÄËÅΩÔºåÈÅ∏Âá∫Ê≠£Á¢∫ÁöÑÂ≠ó</div>
        
        <div class="game-controls">
            <button class="play-sound-btn" onclick="playTargetSound()">üîä Êí≠ÊîæËÅ≤Èü≥</button>
        </div>

        <div class="game-options-grid" id="game-grid">
            <!-- Game Cards Generated Here -->
        </div>
        
        <div style="margin-top: 30px;">
            <button class="btn" onclick="initGame()" style="padding: 10px 20px;">‚è≠Ô∏è ‰∏ã‰∏ÄÈ°å</button>
        </div>
    </div>

    <p class="footer-note">Ë´ãÁ¢∫‰øùË£ùÁΩÆÈü≥ÈáèÂ∑≤ÈñãÂïü ‚Ä¢ Âª∫Ë≠∞‰ΩøÁî® Chrome Êàñ Safari ÁÄèË¶ΩÂô®</p>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settings-modal" onclick="closeSettings(event)">
    <div class="settings-modal">
        <div class="settings-header">
            <span>‚öôÔ∏è Ë®≠ÂÆö</span>
            <button class="close-btn" onclick="toggleSettings()">‚úï</button>
        </div>
        
        <div class="setting-item">
            <label class="setting-label">üî§ ÊñáÂ≠óÂ§ßÂ∞è</label>
            <input type="range" class="range-slider" min="16" max="48" value="24" oninput="updateSetting('fontSize', this.value)">
        </div>

        <div class="setting-item">
            <label class="setting-label">üñºÔ∏è ÂúñÁâáÂ§ßÂ∞è</label>
            <input type="range" class="range-slider" min="20" max="80" value="48" oninput="updateSetting('imgSize', this.value)">
        </div>

        <div class="setting-item">
            <div class="toggle-switch" onclick="document.getElementById('img-toggle').click()">
                <span>È°ØÁ§∫ÂúñÁâá</span>
                <input type="checkbox" class="toggle-checkbox" id="img-toggle" checked onchange="updateSetting('showImg', this.checked)">
            </div>
        </div>
    </div>
</div>

<div class="feedback-overlay">
    <div class="feedback-emoji" id="feedback">üåü</div>
</div>

<script>
    // --- Data Structure with Emojis ---
    const curriculum = [
        {
            id: 1,
            title: "‰∏ªÈ°å‰∏Ä: Á¨¨‰∏ÄÂ§©‰∏äÂ≠∏",
            groups: [
                { root: "Èè°", words: [
                    { t: "Èè°", i: "ü™û" }, { t: "Èè°Âπ≥", i: "ü™û" }, { t: "Èè°Â≠ê", i: "ü™û" }, { t: "ÁúºÈè°", i: "üëì" }
                ]},
                { root: "Â≠∏", words: [
                    { t: "Â≠∏", i: "üìö" }, { t: "Â≠∏Ê†°", i: "üè´" }, { t: "Â≠∏Áîü", i: "üéí" }, { t: "ÂêåÂ≠∏", i: "üë´" }
                ]},
                { root: "ËÄÅ", words: [
                    { t: "ËÄÅ", i: "üë¥" }, { t: "ËÄÅÂ∏´", i: "üë©‚Äçüè´" }, { t: "ËÄÅ‰∫∫", i: "üë¥" }, { t: "ËÄÅËôé", i: "üêØ" }
                ]}
            ],
            sentences: ["ËÄÅÂ∏´Êó©Êô®", "ÊàëÂñúÊ≠°‰∏äÂ≠∏", "ÊàëÊÉ≥‰∏äÂªÅÊâÄ", "Ë¨ùË¨ùËÄÅÂ∏´"]
        },
        {
            id: 2,
            title: "‰∏ªÈ°å‰∫å: Â∞èÁå¥Â≠êÈï∑Â§ß‰∫Ü",
            groups: [
                { root: "Áúº", words: [{t:"Áúº", i:"üëÅÔ∏è"}, {t:"ÁúºÁùõ", i:"üëÄ"}, {t:"ÁúºÊ∑ö", i:"üíß"}] },
                { root: "ËÄ≥", words: [{t:"ËÄ≥", i:"üëÇ"}, {t:"ËÄ≥Êúµ", i:"üëÇ"}, {t:"ËÄ≥Áí∞", i:"üíç"}] },
                { root: "Âè£", words: [{t:"Âè£", i:"üëÑ"}, {t:"ÈñÄÂè£", i:"üö™"}, {t:"Âè£Ë¢ã", i:"üëñ"}] },
                { root: "Èºª", words: [{t:"Èºª", i:"üëÉ"}, {t:"ÈºªÂ≠ê", i:"üëÉ"}, {t:"ÈºªÂ≠î", i:"üëÉ"}] },
                { root: "Êâã", words: [{t:"Êâã", i:"‚úã"}, {t:"ÊâãÊåá", i:"üëÜ"}, {t:"ÊãçÊâã", i:"üëè"}] },
                { root: "ËÖ≥", words: [{t:"ËÖ≥", i:"ü¶∂"}, {t:"ËÖ≥Ë∂æ", i:"ü¶∂"}, {t:"ËÖ≥Âç∞", i:"üë£"}] }
            ],
            sentences: []
        },
        {
            id: 3,
            title: "‰∏ªÈ°å‰∏â: ÊàëÊòØÂì•Âì•",
            groups: [
                { root: "ÂÆ∂Â∫≠", words: [
                    {t:"Áà∏Áà∏", i:"üë®"}, {t:"Â™ΩÂ™Ω", i:"üë©"}, 
                    {t:"Âì•Âì•", i:"üë¶"}, {t:"ÂºüÂºü", i:"üë∂"}, 
                    {t:"ÂßêÂßê", i:"üëß"}, {t:"Â¶πÂ¶π", i:"üë∂"}
                ]}
            ],
            sentences: ["ÊàëÊÑõÁà∏Áà∏", "ÊàëÁöÑÂÆ∂ÊúâÂ™ΩÂ™Ω", "ÊàëÊúÉËá™Â∑±ÂêÉÈ£Ø"]
        },
        {
            id: 4,
            title: "‰∏ªÈ°åÂõõ: Â•ΩÊÉ≥ÂêÉËõãÁ≥ï",
            groups: [
                { root: "Êûú", words: [{t:"Êûú", i:"üçé"}, {t:"Ê∞¥Êûú", i:"üçá"}, {t:"ÊûúÊ±Å", i:"üßÉ"}, {t:"ÊûúÊ®π", i:"üå≥"}] },
                { root: "Ëõã", words: [{t:"Ëõã", i:"ü•ö"}, {t:"ËõãÁ≥ï", i:"üç∞"}, {t:"ÈõûËõã", i:"ü•ö"}] },
                { root: "Ëèú", words: [{t:"Ëèú", i:"ü•¨"}, {t:"Ëî¨Ëèú", i:"ü•ï"}, {t:"ËèúÂàÄ", i:"üî™"}] },
                { root: "ËÇâ", words: [{t:"ËÇâ", i:"ü•©"}, {t:"ÈõûËÇâ", i:"üçó"}, {t:"ÁâõËÇâ", i:"ü•©"}] },
                { root: "È≠ö", words: [{t:"È≠ö", i:"üêü"}, {t:"ÈáëÈ≠ö", i:"üê†"}, {t:"È≠öÁº∏", i:"üè∫"}] },
                { root: "Â§ß", words: [{t:"Â§ß", i:"üêò"}, {t:"Â§ßÁü≥", i:"ü™®"}, {t:"Â§ßÂªà", i:"üè¢"}] },
                { root: "Â∞è", words: [{t:"Â∞è", i:"üêú"}, {t:"Â∞èÈ≥•", i:"üê¶"}, {t:"Â∞èËàπ", i:"‚õµ"}] }
            ],
            sentences: []
        },
        {
            id: 5,
            title: "‰∏ªÈ°å‰∫î: ÁçÖÂ≠êÂ§ßÁéãÊÑõ‰πæÊ∑®",
            groups: [
                { root: "Ê¥ó", words: [{t:"Ê¥ó", i:"üöø"}, {t:"Ê¥óËáâ", i:"üòä"}, {t:"Ê¥óÊâã", i:"üßº"}, {t:"Ê¥óÊæ°", i:"üõÅ"}] },
                { root: "ÊØõ", words: [{t:"ÊØõ", i:"üß∂"}, {t:"ÊØõÂ∑æ", i:"üßñ"}, {t:"ÊØõË°£", i:"üß•"}, {t:"ÁæäÊØõ", i:"üêè"}] },
                { root: "Áâô", words: [{t:"Áâô", i:"ü¶∑"}, {t:"Âà∑Áâô", i:"ü™•"}, {t:"ÁâôÈΩí", i:"ü¶∑"}, {t:"ËõÄÁâô", i:"üò´"}] }
            ],
            sentences: ["ÊàëÊúÉËá™Â∑±Ê¥óËáâ", "ÊàëÊúÉ‰øùÊåÅË∫´È´îÊ∏ÖÊΩî"]
        }
    ];

    // --- State Management ---
    let currentThemeIndex = 0;
    let currentMode = 'learn'; // 'learn' or 'game'
    let voices = [];
    let cantoneseVoice = null;
    let currentTargetWord = null; // For game
    let audioCtx = null; // For sound effects

    // --- TTS Setup ---
    function initSpeech() {
        voices = window.speechSynthesis.getVoices();
        cantoneseVoice = voices.find(voice => voice.lang === 'zh-HK') || 
                         voices.find(voice => voice.lang.includes('zh-HK')) ||
                         voices.find(voice => voice.lang === 'zh-CN');
    }

    window.speechSynthesis.onvoiceschanged = initSpeech;
    setTimeout(initSpeech, 500);

    function speak(text, rate = 0.8) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = rate;
        utterance.pitch = 1.1;
        if (cantoneseVoice) {
            utterance.voice = cantoneseVoice;
            utterance.lang = cantoneseVoice.lang;
        } else {
            utterance.lang = 'zh-HK';
        }
        window.speechSynthesis.speak(utterance);
    }

    // --- Sound Effects using Web Audio API ---
    function initAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }

    function playSoundEffect(type) {
        initAudio();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        if (type === 'correct') {
            // Ding: High pitch sine wave
            osc.type = 'sine';
            osc.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
            osc.frequency.exponentialRampToValueAtTime(1046.5, audioCtx.currentTime + 0.1); // C6
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        } else if (type === 'wrong') {
            // Buzz: Low pitch sawtooth
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        }
    }

    // --- Settings Logic ---
    function toggleSettings() {
        const modal = document.getElementById('settings-modal');
        modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
    }

    function closeSettings(e) {
        if (e.target.className === 'modal-overlay') {
            toggleSettings();
        }
    }

    function updateSetting(type, value) {
        const root = document.documentElement;
        if (type === 'fontSize') {
            root.style.setProperty('--word-size', value + 'px');
        } else if (type === 'imgSize') {
            root.style.setProperty('--img-size', value + 'px');
        } else if (type === 'showImg') {
            root.style.setProperty('--img-display', value ? 'block' : 'none');
        }
    }

    // --- UI Rendering Logic ---

    function init() {
        renderThemeNav();
        renderLearningContent();
    }

    function renderThemeNav() {
        const nav = document.getElementById('theme-nav');
        nav.innerHTML = '';
        curriculum.forEach((theme, index) => {
            const btn = document.createElement('button');
            btn.className = `theme-btn ${index === currentThemeIndex ? 'active' : ''}`;
            btn.textContent = theme.title.split(':')[1];
            btn.onclick = () => {
                currentThemeIndex = index;
                renderThemeNav();
                if (currentMode === 'learn') {
                    renderLearningContent();
                } else {
                    initGame(); // Restart game with new theme
                }
            };
            nav.appendChild(btn);
        });
    }

    function renderLearningContent() {
        const container = document.getElementById('content-display');
        const theme = curriculum[currentThemeIndex];
        container.innerHTML = '';

        // Render Words Section
        if (theme.groups.length > 0) {
            const wordTitle = document.createElement('div');
            wordTitle.className = 'section-title';
            wordTitle.textContent = '‰∏Ä„ÄÅ Ë™çËÆÄÁîüÂ≠ó';
            container.appendChild(wordTitle);

            theme.groups.forEach(group => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'word-group';
                
                const header = document.createElement('div');
                header.className = 'group-header';
                header.innerHTML = `Â≠∏ÁøíÈáçÈªûÔºö<span>${group.root}</span>`;
                groupDiv.appendChild(header);

                const grid = document.createElement('div');
                grid.className = 'cards-grid';
                
                group.words.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'word-card';
                    // Image + Text
                    card.innerHTML = `
                        <div class="word-img">${item.i}</div>
                        <div class="word-text">${item.t}</div>
                    `;
                    card.onclick = () => {
                        speak(item.t);
                        card.classList.add('animate-pop');
                        setTimeout(() => card.classList.remove('animate-pop'), 300);
                    };
                    grid.appendChild(card);
                });

                groupDiv.appendChild(grid);
                container.appendChild(groupDiv);
            });
        }

        // Render Sentences Section
        if (theme.sentences.length > 0) {
            const sentTitle = document.createElement('div');
            sentTitle.className = 'section-title';
            sentTitle.textContent = '‰∫å„ÄÅ Âè£È†≠Ë™™Ë©±';
            container.appendChild(sentTitle);

            const sentList = document.createElement('div');
            sentList.className = 'sentence-list';

            theme.sentences.forEach(sentence => {
                const strip = document.createElement('div');
                strip.className = 'sentence-strip';
                strip.innerHTML = `<span class="speaker-icon">üîä</span> ${sentence}`;
                strip.onclick = () => {
                    speak(sentence);
                    strip.style.background = '#E0F7FA';
                    setTimeout(() => strip.style.background = 'white', 300);
                };
                sentList.appendChild(strip);
            });
            container.appendChild(sentList);
        }
    }

    // --- Game Logic ---
    function switchMode(mode) {
        currentMode = mode;
        const learnBtn = document.getElementById('btn-learn');
        const gameBtn = document.getElementById('btn-game');
        const learnArea = document.getElementById('learn-area');
        const gameArea = document.getElementById('game-area');

        if (mode === 'learn') {
            learnBtn.classList.add('active');
            gameBtn.classList.remove('active');
            learnArea.style.display = 'block';
            gameArea.style.display = 'none';
        } else {
            learnBtn.classList.remove('active');
            gameBtn.classList.add('active');
            learnArea.style.display = 'none';
            gameArea.style.display = 'block';
            initGame();
        }
    }

    function initGame() {
        const theme = curriculum[currentThemeIndex];
        let allWords = [];
        theme.groups.forEach(g => allWords.push(...g.words));

        // Need at least 2 words to play, but UI asks for 6. 
        // If < 6 words in theme, we duplicate or pull from other themes? 
        // For simplicity, just use what we have. If < 6, we show what we have.
        
        if (allWords.length === 0) return;

        // 1. Select Target
        const targetIndex = Math.floor(Math.random() * allWords.length);
        currentTargetWord = allWords[targetIndex];

        // 2. Select Distractors (Total 6 options)
        let options = [currentTargetWord];
        let availableDistractors = allWords.filter(w => w !== currentTargetWord);
        
        // Shuffle available to get random distractors
        availableDistractors.sort(() => Math.random() - 0.5);

        // Fill up to 6 or max available
        while (options.length < 6 && availableDistractors.length > 0) {
            options.push(availableDistractors.pop());
        }

        // Shuffle options for display
        options.sort(() => Math.random() - 0.5);

        // Render
        renderGameGrid(options);
        
        // Auto play sound after slight delay
        setTimeout(() => playTargetSound(), 800);
    }

    function renderGameGrid(options) {
        const grid = document.getElementById('game-grid');
        grid.innerHTML = '';

        options.forEach(opt => {
            const card = document.createElement('div');
            card.className = 'game-card';
            // Always show images in game mode for better UX, or respect setting?
            // Usually games are easier with images. Let's respect setting class but force display block via style if needed.
            // Actually, let's use the same classes so global settings apply.
            card.innerHTML = `
                <div class="word-img">${opt.i}</div>
                <div class="word-text">${opt.t}</div>
            `;
            
            card.onclick = () => handleGameClick(card, opt);
            grid.appendChild(card);
        });
    }

    function playTargetSound() {
        if (currentTargetWord) {
            speak(currentTargetWord.t);
        }
    }

    function handleGameClick(cardElement, selectedOption) {
        if (!currentTargetWord) return;

        if (selectedOption.t === currentTargetWord.t) {
            // CORRECT
            playSoundEffect('correct');
            cardElement.classList.add('correct');
            showFeedback('üåü');
            
            // Speak "Correct" then the word
            // Since speak() cancels previous, we chain them or just speak the word happily
            // Let's just speak the word clearly.
            speak("Á≠îÂ∞ç‰∫ÜÔºÅ" + currentTargetWord.t);

            // Disable all cards to prevent multiple clicks
            const allCards = document.querySelectorAll('.game-card');
            allCards.forEach(c => c.style.pointerEvents = 'none');

            // Auto next question? Or wait for user. Let's wait for user or auto after long delay.
            // Let's just leave it for user to click "Next".

        } else {
            // WRONG
            playSoundEffect('wrong');
            cardElement.classList.add('wrong');
            showFeedback('üí™'); // "Keep going" emoji
            
            // Speak the WRONG word they clicked (to reinforce learning)
            speak(selectedOption.t + "„ÄÇ ÂÜçË©¶‰∏ÄÊ¨°ÔºÅ");

            // Remove wrong class after animation
            setTimeout(() => cardElement.classList.remove('wrong'), 500);
        }
    }

    function showFeedback(emoji) {
        const el = document.getElementById('feedback');
        el.textContent = emoji;
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 1000);
    }

    // Start App
    init();

</script>
</body>
</html>